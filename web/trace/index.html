<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>quick trace web interface</title>

    <link href="../bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../bootstrap-3.3.7-dist/css/dashboard.css" rel="stylesheet">
</head>

<body>
<script src="../bootstrap-3.3.7-dist/js/jquery.min.js"></script>
<script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<script src="../bootstrap-3.3.7-dist/js/howler.min.js"></script>
<div class="container-fluid">
    <div class="row">
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">TRACE WEB INTERFACE</a>
            </div>
    
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a><span id="notification_badge" class="badge progress-bar-danger"style="display: none;">1</span></a></li>
                    <li><a href="#">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="col-md-12">
       <div class="page-header">
         <div class='btn-toolbar pull-right'>
           <div class='btn-group'>
             <button id="add_btn" class="btn btn-default form-control pull-right" style="border: 1px solid #5cb85c; color: #5cb85c; outline: none;"><span class="glyphicon glyphicon-plus"></span></button>
           </div>
         </div>
         <h2>Task List</h2>
     </div>

       <div>
           <table class="table table-bordered col-md-10" id="task_list">
           <thead>
             <th style="vertical-align: middle;">#</th>
             <th style="vertical-align: middle;">ID</th>
             <th style="vertical-align: middle;">Status</th>
             <th>
               <div class="form-inline form-group">
                 <button class="btn btn-default form-control pull-right" style="outline: none;"><span class="glyphicon glyphicon-edit"></span></button>
               </div>
             </th>
           </thead>
           <tbody></tbody>
           </table>
           <p id="notask">No tasks yet, press the '+' icon to create one</p>
       </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="input_modal" tabindex="-1" role="dialog" aria-labelledby="input_modal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Input</h4> </div>
            <div class="modal-body">
                <div class="row"><div class="col-md-12">
                <div>
                    <h2 class="sub-header">Target</h2>
                </div>
                <div>
                    <label for="target_text"><a id="opt1">browse</a> or <a id="opt2">paste</a></label>
                    <div id="target_text_form">
                    <div class="form-group">
                        <textarea class="form-control" id="target_text" rows="10"></textarea>
                    </div>
                    <button type="submit" class="btn btn-default" id="go_btn1">go</button>
                    </div>
                </div>
                <div id="target_browse_form" class="form-inline form-group" style="display: none;">
                <div class="col-12">
                    <div class="input-group">
                        <label class="input-group-btn">
                            <span class="btn btn-default">
                                Browseâ€¦ <input id="browse" type="file" style="display: none;" multiple="">
                            </span>
                        </label>
                        <input id="file" type="text" class="form-control" readonly="">
                    </div>
                <button type="submit" class="btn btn-default" id="go_btn2">go</button>
                </div>
                </div>

                <div id="output" style="display: none;">
                    <h2 class="sub-header">Task Detail</h2>
                    <p id="fail" style="display: none;">failed to start up the task</p>
                    <table class="table table-bordered table-hover col-md-10" id="detail_table"></table>
                </div>
            </div>
            </div></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
</div>
<script>
var paste=true;
$(function() {
      $('#browse').on('change', function(files) {
          var file = this.files[0];
          $("#file").val(file.name);
      });
      $('#opt1').on('click',function(){
          if(paste){
              $('#target_text_form').css("display","none");
              $('#target_browse_form').css("display","block");
              paste=false;
          }
      });
      $('#opt2').on('click',function(){
          if(!paste){
              $('#target_text_form').css("display","block");
              $('#target_browse_form').css("display","none");
              paste=true;
          }
      });

      var host = "47.90.99.168";
      var wsport = "1236";
      var notification_num = 0;
      var ignore = true;
      var sms_sound = new Howl({
        src: ['../bootstrap-3.3.7-dist/assets/sms.mp3']
      });

      function start_ws(){
          ws = new WebSocket("ws://" + host + ":" + wsport + "/ws");
           
          ws.onmessage = function(evt) {
            console.log("message received: " + evt.data);
            result_json = JSON.parse(evt.data);
            var result_len = result_json.result_list.length;
            if (result_len > 0){
                if (result_len > notification_num){
                  notification_num = result_len;
                  if (!ignore){
                    sms_sound.play();
                  }else{
                    ignore = false;
                  }
                }
                $('#notification_badge').css("display","block");
                $('#notification_badge').html(result_len);
            }else{
                $('#notification_badge').css("displah","none");
                $('#notification_badge').html(0);
            }
            reload_list();
          };
 
          ws.onclose = function(evt) {
            console.log("Connection close");
          };
 
          ws.onopen = function(evt) { 
            console.log("Connection Opened");
          };
      }

      var baseurl = "http://47.90.99.168:1235/";
      function on_trace_dispatched(data, status, xhr){
          console.log(data);
          data_dict = JSON.parse(data);
          $('#output').css("display","block");
          if(data_dict.status){
              $('#fail').css("display","block");
          }else{
              $('#detail_table').append("<thead><th>Attr</th><th>Value</th></thead>");
              $('#detail_table').append("<tbody></tbody>");
              $('#detail_table tbody').append("<tr><td>cycle id</td><td>"+data_dict.date+"</td></tr>");
              $('#detail_table tbody').append("<tr><td>output file</td><td><a>"+data_dict.out_file+"</a></td></tr>");
              $('#detail_table tbody').append("<tr><td>target file</td><td><a>"+data_dict.target_file+"</a></td></tr>");
          }
          $('#go_btn1').prop("disabled",true);
          reload_list();
      }
      function reload_input(){
          $('#go_btn1').prop("disabled",false);
          $('#output').css("display","none");
          $('#fail').css("display","none");
          $('#detail_table').html('');
          $('#target_text').val('');
      }
      $('#go_btn1').on('click',function(){
          var target_text = $('#target_text').val();
          if (target_text == "") {
            alert("empty target");
            return;
          }
          $.ajax(baseurl + "trace", {
              type: 'POST',
              data: {target: target_text},
              success: on_trace_dispatched,
              error: function (jqXhr, textStatus, errorMessage) {console.log('Error' + errorMessage);}
          });
      });
      $('#add_btn').on('click',function(){
          reload_input();
          $('#input_modal').modal();
      });
     
      function fill_table(data, status, xhr){
        data_dict = JSON.parse(data);
        var task_list = data_dict.task_list;
        var output_dir = data_dict.output_dir;
        if (task_list.length){
          $('#notask').css("display","none");
        }else{
          $('#notask').css("display","block");
        }

        tbl = $('#task_list tbody');
        tbl.html('');
        for (var i=0; i<task_list.length; i++){
          var row = tbl.append("<tr class='real'></tr>");
          row.find(".real:last-child")
             .append("<td>"+parseInt(i+1)+"</td>");
          row.find(".real:last-child")
             .append("<td>"+task_list[i][0]+"</td>");
          row.find(".real:last-child")
             .append("<td>"+( task_list[i][1]==2 ? "probing" : (task_list[i][1]==3?"finished":"finished & read") )+"</td>");
          row.find(".real:last-child")
             .append("<td class='text-center'><a style=cursor:pointer data-toggle='collapse' href='#inline_div" + i.toString() + "' aria-expanded='false' aria-controls='inline_div" + i.toString() + "'> expand&nbsp<span class='glyphicon glyphicon-menu-down'></span></a><input class='pull-right' type='checkbox' style='display: none;'></input></td>");

          var row = tbl.append("<tr class='fake' style='display: none;'></tr>");
          row.find(".fake:last-child")
             .append("<td colspan='100%'><div id='inline_div" + i.toString() + "' class='collapse col-md-10'></div></td>");
          row.find(".fake:last-child").on('hide.bs.collapse', function () {$(this).css("display","none");});
          row.find(".fake:last-child").on('show.bs.collapse', function () {$(this).css("display","");});

          var div = row.find(".fake:last-child div");
          div.append("<table class='table table-bordered col-md-10'></table>");
          div.find("table").append("<thead><tr></tr></thead>");
	  div.find("table thead tr").append("<th>target_file</th>");
	  div.find("table thead tr").append("<th>result_file</th>");
          div.find("table").append("<tbody></tbody>");
          div.find("table tbody").append("<tr class='inner_row'></tr>");
	  div.find(".inner_row:last-child").append("<td><a>"+output_dir+"/"+task_list[i][0]+".target</a></td>");
	  div.find(".inner_row:last-child").append("<td><a>"+output_dir+"/"+task_list[i][0]+".warts</a></td>");
        }
      }
      
      function dropdown_click(){}

      function reload_list(){
          $.ajax(baseurl + "list", {
              type: 'POST',
              data: {user: "anonymous"},
              success: fill_table,
              error: function (jqXhr, textStatus, errorMessage) {console.log('Error' + errorMessage);}
          });
      }

      start_ws();
      reload_list();
});
</script>
</body>
</html>
